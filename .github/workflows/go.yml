# This workflow will build a golang project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-go

name: Go

on:
  push:
    branches: [ "master" ]
  pull_request:
    types:
      - closed
      - opened
      - synchronize
    branches: [ "master" ]
    
  workflow_dispatch:
     inputs:
      workflow_02:
        description: 'ًWorkflow 2 which will be triggered'
        required: true
        default: 'workflow_02'

      workflow2_github_account:
        description: 'GitHub Account Owner'
        required: true
        default: 'huavanthong'

      workflow2_repo_github:
        description: 'GitHub Repository Name'
        required: true
        default: 'microservice-golang' 

env:
  CURRENT_RUNNER_ID: ${{ github.run_id }}
  GH_TOKEN: ${{ github.token }}

jobs:

  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.20'

    - name: Build
      run: go build -v ./...

    - name: Test
      run: go test -v ./...

    # - name: Build with logs
    #   run: |
    #     mkdir ${{ runner.temp }}/build_logs
    #     ./build.sh --log-path ${{ runner.temp }}/build_logs

    # - name: Upload logs on fail
    #   if: ${{ failure() }}
    #   uses: actions/upload-artifact@v3
    #   with:
    #     name: Build failure logs
    #     path: ${{ runner.temp }}/build_logs

  trigger-build-aio:
    runs-on: ubuntu-latest

    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - name: Test
        run: |
          echo "GitHub Repository: $GITHUB_REPOSITORY"
          # Lấy giá trị của GITHUB_REF
          PR_BRANCH="${{ github.ref }}"
          
          # Trích xuất tên nhánh từ biến GITHUB_REF
          PR_BRANCH=${PR_BRANCH#refs/heads/}
          
          echo "Pull Request Branch: $PR_BRANCH"

          # Lấy giá trị của nhánh tạo pull request
          TARGET_BRANCH="${{ github.head_ref }}"
          echo "Pull Request Branch from variable github: $TARGEt_BRANCH"

          curl -L \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/OWNER/REPO/dispatches \
            -d '{"event_type":"on-demand-test","client_payload":{"repository": "'"$GITHUB_REPOSITORY"'", "branch" : "'"$PR_BRANCH"'", "pull-branch": "'"$TARGET_BRANCH"'" }}'

          # curl -X POST https://api.github.com/repos/huavanthong/microservice-golang/dispatches \
          # --header 'authorization: Bearer ${{ secrets.GITHUB_TOKEN }}' \
          # -H 'Accept: application/vnd.github.everest-preview+json' \
          # --data '{"event_type": "Trigger Workflow", "client_payload": { "repository": "'"$GITHUB_REPOSITORY"'", "branch" : "'"$PR_BRANCH"'", "pull-branch": "'"$TARGET_BRANCH"'" }}'

  collect-log:
    name: Collect console log
    runs-on: ubuntu-latest
    needs: build  
    steps:
    - name: Check out repo's default branch
      uses: actions/checkout@v3

    - name: Collect log 
      run: |
        echo "Current runner id: $CURRENT_RUNNER_ID"
        gh run view $CURRENT_RUNNER_ID --log > console_log.txt

    - name: Upload built package
      uses: actions/upload-artifact@v3
      with:
        name: upload log artifacts
        path: console_log.txt