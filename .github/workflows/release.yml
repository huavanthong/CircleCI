name: Release

on:
  push:
    tags:
      - "*"
  pull_request:
    types:
      - closed
      - opened
      - synchronize
    branches: 
      - master
  workflow_call:
  
  workflow_dispatch:
    
env:
  GH_TOKEN: ${{ github.token }}

jobs:
  display-variables:
    runs-on: ubuntu-latest
    steps:
      - name: Set environment variable in job A
        run: echo "MY_ENV_VAR=example_value_hello" >> $GITHUB_ENV
  
  # call-build-process:
  #   needs: [display-variables]
  #   uses: huavanthong/CircleCI/.github/workflows/build.yml@master
      
  update-control-file:
    name: Update content
    runs-on: ubuntu-latest
    # needs: [call-build-process]
    if: ${{ github.ref_type == 'tag' }}
    steps:
    - name: Checkout source
      uses: actions/checkout@v3

    - name: Set Up Git User
      run: |
        git config user.email "huavanthong14@gmail.com"
        git config user.name "Thong Hua"

    - name: Checkout automation branch
      run: |
        tag_branch=htv3hc/feat/tag-version-0.0.2
        echo $tag_branch > tag_branch.txt
    
        git checkout -b $tag_branch  

    - name: Update contents
      run: |
        echo tag-$(date +%d.%m.%Y-%H.%M.%S) > content.txt
      
    - name: Commit Changes
      run: |
        tag_branch=$(cat tag_branch.txt)
        git add content.txt
        git commit -m "Auto commit from GitHub Actions"
        git push -u -f origin $tag_branch

    - name: Create Pull Request
      run: |
        tag_branch=$(cat tag_branch.txt)

        pr_exists=$(gh pr list --base develop --head $tag_branch | grep "Auto-generated PR")
        # Github CLI for pull request.
        if [ -z "$pr_exists" ]; then
          # Pull request chưa tồn tại, tạo mới
          echo "Pull request not found. Creating a new one..."
          gh pr create \
          --base master --head $tag_branch \
          --title "Auto-generated PR" \
          --body "This PR was automatically generated by GitHub Actions." \
          --assignee huavanthong \
          --reviewer huavanthong
        else
          # Pull request đã tồn tại, thông báo và không thực hiện thêm hành động
          echo "Pull request already exists. Skipping..."
        fi

